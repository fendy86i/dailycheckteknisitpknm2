<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Check Teknisi</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<h1>Daily Check Teknisi</h1>

<div class="card">
    <div id="loading">Memuat data...</div>
    <div class="table-wrapper">
        <table id="dailyTable" style="display:none">
            <thead><tr id="headerRow"></tr></thead>
            <tbody id="tableBody"></tbody>
            <tfoot><tr id="footerRow"></tr></tfoot>
        </table>
    </div>

    <div class="nav-bottom">
        <button class="nav-circle" onclick="shiftDay(-1)">◀</button>
        <button class="nav-circle" onclick="shiftDay(1)">▶</button>
    </div>
</div>

<script>
// REPLACE WITH YOUR ACTUAL DEPLOYED URL
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyDpgtW2Pk6NkXjtJ_N0EH3RC4IU7UUSw5aRxQTk2md-P1t8yseY0wIZDsFk9raupEq4A/exec";

function localISO(d){
    return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");
}

const today = new Date();
today.setHours(0,0,0,0);

let startDate = new Date(today);
let cachedData = [];
let originalOrder = [];
let dateWindow = [];
let sortState = {};

function buildDateWindow(){
    dateWindow = [];
    for(let i=0;i<7;i++){
        const d = new Date(startDate);
        d.setDate(startDate.getDate()+i);
        dateWindow.push({
            label: d.toLocaleDateString("id-ID",{day:"numeric",month:"short"}),
            iso: localISO(d),
            future: d > today
        });
    }
}

function header(label,key,type){
    return `<div class="header-wrap">
        <span>${label}</span>
        <button class="sort-one" onclick="sortColumn('${key}','${type}',this)">▲</button>
    </div>`;
}

function buildHeaderFooter(){
    const headerRow = document.getElementById("headerRow");
    const footerRow = document.getElementById("footerRow");
    
    headerRow.innerHTML = `<th class="sticky-alat col-alat">${header("Alat","Alat","text")}</th>`;

    dateWindow.forEach(d=>{
        const th=document.createElement("th");
        th.className="date-col";
        th.innerHTML=header(d.label,d.iso,"date");
        headerRow.appendChild(th);
    });

    footerRow.innerHTML=`<th class="sticky-alat col-alat">Done</th>`;
    dateWindow.forEach(()=>footerRow.appendChild(document.createElement("td")));
}

// Added ?getDashboard=true to the URL
fetch(SCRIPT_URL + "?getDashboard=true&t=" + Date.now())
.then(r=>r.json())
.then(j=>{
    cachedData=j.data||[];
    originalOrder=[...cachedData];
    document.getElementById("loading").style.display="none";
    document.getElementById("dailyTable").style.display="table";
    render();
})
.catch(err => {
    document.getElementById("loading").innerText = "Gagal memuat data. Periksa Deployment script Anda.";
});

function render(){
    buildDateWindow();
    buildHeaderFooter();
    buildTable();
}

function buildTable(){
    const tableBody = document.getElementById("tableBody");
    tableBody.innerHTML="";
    cachedData.forEach(r=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td class="sticky-alat col-alat">${r.Alat||""}</td>`;
        dateWindow.forEach(d=>{
            let v = d.future ? null : r[d.iso];
            let html="—";
            if(v==="Done") html=`<span class="pill done">Done</span>`;
            if(v==="Miss") html=`<span class="pill miss">Miss</span>`;
            if(v==="Open") html=`<span class="pill open">Open</span>`;
            tr.innerHTML+=`<td class="date-col">${html}</td>`;
        });
        tableBody.appendChild(tr);
    });
    updateFooter();
}

function updateFooter(){
    const footerRow = document.getElementById("footerRow");
    dateWindow.forEach((d,i)=>{
        if(d.future){ footerRow.cells[i+1].textContent="—"; return; }
        let c=0;
        document.querySelectorAll("#tableBody tr").forEach(r=>{
            if(r.cells[i+1].innerText==="Done") c++;
        });
        footerRow.cells[i+1].textContent=c||"—";
    });
}

function sortColumn(key,type,btn){
    const s=sortState[key]??0;
    sortState={}; sortState[key]=(s+1)%3;
    document.querySelectorAll(".sort-one").forEach(b=>b.textContent="▲");

    if(sortState[key]===0){ cachedData=[...originalOrder]; btn.textContent="△"; }
    else if(sortState[key]===1){
        btn.textContent="▲";
        cachedData.sort((a,b)=>type==="text" 
            ? (a[key]||"").localeCompare(b[key]||"") 
            : (b[key]==="Done")-(a[key]==="Done"));
    }
    else {
        btn.textContent="▼";
        cachedData.sort((a,b)=>type==="text" 
            ? (b[key]||"").localeCompare(a[key]||"") 
            : (a[key]==="Done")-(b[key]==="Done"));
    }
    buildTable();
}

function shiftDay(d){
    const n=new Date(startDate);
    n.setDate(startDate.getDate()+d);
    if(n>today) return;
    startDate=n;
    render();
}
</script>
</body>
</html>
